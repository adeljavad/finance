# تسک: سیستم حذف داده‌های ایمپورت شده

## هدف
اضافه کردن قابلیت حذف داده‌های قبلاً ایمپورت شده برای امکان ایمپورت مجدد فایل‌های اکسل به‌روزرسانی شده

## تحلیل وضعیت فعلی

### مدل‌های موجود:
- **FinancialFile**: اطلاعات فایل‌های آپلود شده
- **DocumentHeader**: سربرگ اسناد مالی
- **DocumentItem**: آرتیکل‌های اسناد
- **ChartOfAccounts**: سرفصل‌های حساب
- **ImportJob**: کارهای ایمپورت

### روابط:
- DocumentHeader → DocumentItem (One-to-Many)
- DocumentHeader → Company, FinancialPeriod
- DocumentItem → ChartOfAccounts
- FinancialFile → Company, FinancialPeriod

## طراحی سیستم حذف

### سرویس DataCleanupService:
```python
class DataCleanupService:
    def delete_imported_data(company, period):
        # حذف DocumentItem و DocumentHeader
        # حفظ ChartOfAccounts (ممکن است در سایر اسناد استفاده شود)
        # مدیریت تراکنش اتمی
```

### الگوریتم حذف:
1. **جستجوی داده‌های ایمپورت شده** برای شرکت و دوره مشخص
2. **حذف DocumentItem** (آرتیکل‌های سند)
3. **حذف DocumentHeader** (سربرگ اسناد)
4. **حفظ ChartOfAccounts** (سرفصل‌های حساب)
5. **بروزرسانی وضعیت FinancialFile**

### جریان کاربر:
1. کاربر فایل جدید آپلود می‌کند
2. در صفحه پیش‌نمایش، checkbox "حذف داده‌های قبلی" نمایش داده می‌شود
3. کاربر انتخاب می‌کند
4. قبل از ایمپورت جدید، داده‌های قبلی حذف می‌شوند
5. ایمپورت جدید انجام می‌شود

## تغییرات مورد نیاز

### 1. ایجاد سرویس DataCleanupService
- `data_importer/services/data_cleanup_service.py`
- متد `delete_imported_data`
- مدیریت cascade delete

### 2. اصلاح DataIntegrationService
- اضافه کردن پارامتر `delete_existing_data`
- یکپارچه‌سازی با DataCleanupService
- مدیریت تراکنش‌های اتمی

### 3. اصلاح views.py
- اضافه کردن checkbox در صفحه پیش‌نمایش
- ارسال پارامتر به سرویس ایمپورت
- نمایش هشدارهای مناسب

### 4. اصلاح templates
- اضافه کردن checkbox در `preview.html`
- نمایش پیام‌های وضعیت

## تست‌ها

### تست 1: حذف داده‌های ایمپورت شده
- ایجاد داده‌های تست
- اجرای حذف
- بررسی حذف DocumentHeader و DocumentItem
- بررسی حفظ ChartOfAccounts

### تست 2: ایمپورت مجدد
- حذف داده‌های قبلی
- ایمپورت فایل جدید
- بررسی صحت داده‌های جدید

### تست 3: یکپارچگی داده‌ها
- بررسی عدم تأثیر بر سایر شرکت‌ها
- بررسی عدم تأثیر بر سایر دوره‌ها
- بررسی حفظ ChartOfAccounts

## نکات فنی

### مدیریت تراکنش:
- استفاده از `transaction.atomic()`
- جلوگیری از وضعیت نیمه‌کاره

### مدیریت خطا:
- لاگ خطاها
- نمایش پیام‌های مناسب به کاربر
- بازگشت به وضعیت قبلی در صورت خطا

### عملکرد:
- حذف دسته‌ای برای داده‌های زیاد
- مدیریت حافظه
- جلوگیری از timeout

## مزایا

- ✅ امکان ایمپورت مجدد فایل‌های به‌روزرسانی شده
- ✅ جلوگیری از داده‌های تکراری
- ✅ مدیریت آسان داده‌ها
- ✅ حفظ یکپارچگی سیستم
- ✅ تجربه کاربری بهتر

## ریسک‌ها و راهکارها

### ریسک 1: حذف ناخواسته داده‌ها
- **راهکار**: نمایش هشدار واضح قبل از حذف
- **راهکار**: نیاز به تأیید کاربر

### ریسک 2: تأثیر بر سایر بخش‌ها
- **راهکار**: حذف فقط داده‌های مربوط به شرکت و دوره مشخص
- **راهکار**: حفظ ChartOfAccounts

### ریسک 3: عملکرد در داده‌های زیاد
- **راهکار**: حذف دسته‌ای
- **راهکار**: نمایش پیشرفت
