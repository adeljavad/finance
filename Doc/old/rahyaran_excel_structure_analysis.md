# تحلیل ساختار فایل اکسل راهکاران

## ساختار ستون‌های راهکاران

### ستون‌های اصلی کدینگ:

| ستون اکسل | نوع | سطح کدینگ | توضیحات |
|-----------|-----|-----------|----------|
| **Title1 / Code1** | گروه | CLASS | سطح بالاترین (مثلاً: دارایی‌ها، بدهی‌ها) |
| **Title2 / Code2** | کل | SUBCLASS | سطح دوم (مثلاً: دارایی‌های جاری، دارایی‌های ثابت) |
| **Title3 / Code3** | معین | DETAIL | سطح سوم (مثلاً: صندوق، بانک، حساب‌های دریافتنی) |
| **Title4 / Code4** | تفصیلی | DETAIL | سطح چهارم (مثلاً: حساب‌های تفصیلی مشتریان) |

### ستون‌های تراکنش‌ها:

| ستون اکسل | نوع | توضیحات |
|-----------|-----|----------|
| **شماره سند** | شناسه | شماره منحصربه‌فرد سند |
| **تاریخ سند** | تاریخ | تاریخ سند به صورت فارسی |
| **شرح سند** | متن | توضیحات کلی سند |
| **بدهکار** | عدد | مبلغ بدهکار |
| **بستانکار** | عدد | مبلغ بستانکار |

## الگوریتم ایجاد سطوح کدینگ

### مرحله 1: ایجاد حساب‌های گروه (CLASS)
- **کد**: Code1
- **نام**: Title1  
- **سطح**: CLASS
- **والد**: ندارد (سطح ریشه)

### مرحله 2: ایجاد حساب‌های کل (SUBCLASS)
- **کد**: Code2
- **نام**: Title2
- **سطح**: SUBCLASS  
- **والد**: حساب گروه مربوطه (بر اساس Code1)

### مرحله 3: ایجاد حساب‌های معین (DETAIL)
- **کد**: Code3
- **نام**: Title3
- **سطح**: DETAIL
- **والد**: حساب کل مربوطه (بر اساس Code2)

### مرحله 4: ایجاد حساب‌های تفصیلی (DETAIL)
- **کد**: Code4
- **نام**: Title4
- **سطح**: DETAIL
- **والد**: حساب معین مربوطه (بر اساس Code3)

## نمونه داده‌های راهکاران

```python
# نمونه ردیف از فایل اکسل راهکاران
{
    'Title1': 'دارایی‌ها',
    'Code1': '1',
    'Title2': 'دارایی‌های جاری', 
    'Code2': '11',
    'Title3': 'صندوق',
    'Code3': '111',
    'Title4': 'صندوق اصلی',
    'Code4': '11101',
    'شماره سند': '1001',
    'تاریخ سند': '1403/01/15',
    'شرح سند': 'دریافت نقدی از فروش',
    'بدهکار': 50000000,
    'بستانکار': 0
}
```

## ساختار درختی کدینگ

```
1 - دارایی‌ها (CLASS)
├── 11 - دارایی‌های جاری (SUBCLASS)  
│   ├── 111 - صندوق (DETAIL)
│   │   └── 11101 - صندوق اصلی (DETAIL)
│   └── 112 - بانک (DETAIL)
└── 12 - دارایی‌های ثابت (SUBCLASS)
```

## تغییرات مورد نیاز در DataIntegrationService

### 1. اضافه کردن متد `create_chart_of_accounts_hierarchy`
- ایجاد سلسله مراتب کامل حساب‌ها
- مدیریت ارتباط parent-child
- جلوگیری از ایجاد حساب‌های تکراری

### 2. اصلاح متد `map_account_code`
- جستجوی حساب بر اساس کد کامل (Code4)
- ایجاد حساب‌های والد در صورت عدم وجود
- حفظ سلسله مراتب

### 3. اصلاح متد `_create_document_item`
- استفاده از کد کامل (Code4) برای مپ کردن حساب
- انتقال توضیحات به آیتم سند
- خالی کردن توضیحات سربرگ سند

## تست و اعتبارسنجی

### تست 1: ایجاد سطوح کدینگ
- بررسی ایجاد حساب‌های CLASS, SUBCLASS, DETAIL
- بررسی ارتباط parent-child
- بررسی عدم تکراری بودن حساب‌ها

### تست 2: تخصیص توضیحات
- بررسی خالی بودن توضیحات سربرگ سند
- بررسی انتقال توضیحات به آیتم‌های سند
- بررسی یکپارچگی داده‌ها

### تست 3: گزارش‌های مالی
- تست تراز چهارستونی با داده‌های واقعی
- تست تحلیل نسبت‌های مالی
- تست شناسایی انحرافات
