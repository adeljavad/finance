{% extends 'base/base.html' %}
{% load static %}
{% load persian_filters %}

{% block title %}داشبورد - {{ company.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="fw-bold text-dark mb-1">
            <i class="bi bi-speedometer2 me-2"></i>
            داشبورد شرکت
        </h3>
        <p class="text-muted mb-0">{{ company.name }}</p>
    </div>
    
    <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-building me-1"></i>
            {{ company.name }}
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'users:company_selection' %}">
                <i class="bi bi-building me-2"></i>تغییر شرکت
            </a></li>
            <li><a class="dropdown-item" href="{% url 'users:company_list' %}">
                <i class="bi bi-list-ul me-2"></i>لیست شرکت‌ها
            </a></li>
        </ul>
    </div>
</div>

<!-- آمار و اطلاعات -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="fw-bold text-primary mb-0">{{ company.get_active_members_count }}</h4>
                    <p class="text-muted mb-0">اعضای فعال</p>
                </div>
                <div class="bg-primary rounded-circle p-3">
                    <i class="bi bi-people text-white fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="fw-bold text-success mb-0">{{ financial_periods.count }}</h4>
                    <p class="text-muted mb-0">دوره‌های مالی</p>
                </div>
                <div class="bg-success rounded-circle p-3">
                    <i class="bi bi-calendar-check text-white fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="fw-bold text-warning mb-0">{{ company.current_fiscal_year }}</h4>
                    <p class="text-muted mb-0">سال مالی جاری</p>
                </div>
                <div class="bg-warning rounded-circle p-3">
                    <i class="bi bi-calendar-date text-white fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="role-badge role-{{ user_role.role|lower }} fs-6">
                        {{ user_role.get_role_display }}
                    </span>
                    <p class="text-muted mb-0 mt-1">نقش شما</p>
                </div>
                <div class="bg-info rounded-circle p-3">
                    <i class="bi bi-person-badge text-white fs-4"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- اطلاعات شرکت -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-light py-3">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    اطلاعات شرکت
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-sm-6">
                        <strong>نام شرکت:</strong>
                        <p class="text-muted mb-0">{{ company.name }}</p>
                    </div>
                    <div class="col-sm-6">
                        <strong>نوع شرکت:</strong>
                        <p class="text-muted mb-0">{{ company.get_company_type_display }}</p>
                    </div>
                    <div class="col-sm-6">
                        <strong>کد اقتصادی:</strong>
                        <p class="text-muted mb-0">{{ company.economic_code }}</p>
                    </div>
                    <div class="col-sm-6">
                        <strong>شناسه ملی:</strong>
                        <p class="text-muted mb-0">{{ company.national_code }}</p>
                    </div>
                    <div class="col-12">
                        <strong>آدرس:</strong>
                        <p class="text-muted mb-0">{{ company.address|default:"ثبت نشده" }}</p>
                    </div>
                    <div class="col-sm-6">
                        <strong>تلفن:</strong>
                        <p class="text-muted mb-0">{{ company.phone|default:"ثبت نشده" }}</p>
                    </div>
                    <div class="col-sm-6">
                        <strong>ایمیل:</strong>
                        <p class="text-muted mb-0">{{ company.email|default:"ثبت نشده" }}</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <a href="{% url 'users:company_detail' company.id %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye me-1"></i>
                        مشاهده جزئیات کامل
                    </a>
                    {% if user_role.role in 'OWNER,ADMIN' %}
                    <a href="{% url 'users:update_company' company.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-pencil me-1"></i>
                        ویرایش اطلاعات
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- دوره‌های مالی -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-light py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar me-2"></i>
                        دوره‌های مالی
                    </h5>
                    {% if user_role.can_manage_financial_data %}
                    <a href="{% url 'users:create_financial_period' company.id %}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>
                        دوره جدید
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if financial_periods %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>نام دوره</th>
                                <th>تاریخ شروع</th>
                                <th>تاریخ پایان</th>
                                <th>وضعیت</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for period in financial_periods %}
                            <tr>
                                <td>{{ period.name }}</td>
                                <td>{{ period.start_date|to_persian_date }}</td>
                                <td>{{ period.end_date|to_persian_date }}</td>
                                <td>
                                    {% if period.is_active %}
                                    <span class="badge bg-success">فعال</span>
                                    {% else %}
                                    <span class="badge bg-secondary">غیرفعال</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">هیچ دوره مالی تعریف نشده است</p>
                    {% if user_role.can_manage_financial_data %}
                    <a href="{% url 'users:create_financial_period' company.id %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>
                        ایجاد دوره مالی
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- دسترسی‌های سریع -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light py-3">
                <h5 class="mb-0">
                    <i class="bi bi-lightning me-2"></i>
                    دسترسی‌های سریع
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% if user_role.can_manage_users %}
                    <div class="col-md-3 col-6">
                        <a href="{% url 'users:manage_company_members' company.id %}" 
                           class="btn btn-outline-primary w-100 h-100 py-3">
                            <i class="bi bi-people fs-2 d-block mb-2"></i>
                            مدیریت اعضا
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if user_role.can_manage_financial_data %}
                    <div class="col-md-3 col-6">
                        <a href="{% url 'data_importer:dashboard' %}" class="btn btn-outline-success w-100 h-100 py-3">
                            <i class="bi bi-currency-exchange fs-2 d-block mb-2"></i>
                            ورود داده مالی
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if user_role.can_view_reports %}
                    <div class="col-md-3 col-6">
                        <a href="{% url 'financial_system:financial_chatbot' %}" class="btn btn-outline-info w-100 h-100 py-3">
                            <i class="bi bi-robot fs-2 d-block mb-2"></i>
                            دستیار مالی
                        </a>
                    </div>
                    
                    <div class="col-md-3 col-6">
                        <a href="{% url 'financial_system:reports' %}" class="btn btn-outline-warning w-100 h-100 py-3">
                            <i class="bi bi-graph-up fs-2 d-block mb-2"></i>
                            گزارش‌های مالی
                        </a>
                    </div>
                    {% endif %}
                    
                    <div class="col-md-3 col-6">
                        <a href="{% url 'users:company_detail' company.id %}" 
                           class="btn btn-outline-secondary w-100 h-100 py-3">
                            <i class="bi bi-building fs-2 d-block mb-2"></i>
                            اطلاعات شرکت
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
