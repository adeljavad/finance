{% extends 'base/base.html' %}
{% load static %}

{% block title %}جزئیات شرکت - {{ company.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="fw-bold text-dark mb-1">
            <i class="bi bi-building me-2"></i>
            جزئیات شرکت
        </h3>
        <p class="text-muted mb-0">{{ company.name }}</p>
    </div>
    
    <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-gear me-1"></i>
            عملیات
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            {% if user_role.role in 'OWNER,ADMIN' %}
            <li>
                <a class="dropdown-item" href="{% url 'users:update_company' company.id %}">
                    <i class="bi bi-pencil me-2"></i>
                    ویرایش اطلاعات
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="{% url 'users:manage_company_members' company.id %}">
                    <i class="bi bi-people me-2"></i>
                    مدیریت اعضا
                </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            {% endif %}
            <li>
                <a class="dropdown-item" href="{% url 'users:company_list' %}">
                    <i class="bi bi-list-ul me-2"></i>
                    لیست شرکت‌ها
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="{% url 'users:company_selection' %}">
                    <i class="bi bi-arrow-left-right me-2"></i>
                    تغییر شرکت
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- آمار سریع -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="fw-bold text-primary mb-0">{{ stats.total_members }}</h4>
                    <p class="text-muted mb-0">اعضای فعال</p>
                </div>
                <div class="bg-primary rounded-circle p-3">
                    <i class="bi bi-people text-white fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="fw-bold text-success mb-0">{{ stats.active_periods }}</h4>
                    <p class="text-muted mb-0">دوره‌های فعال</p>
                </div>
                <div class="bg-success rounded-circle p-3">
                    <i class="bi bi-calendar-check text-white fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="fw-bold text-warning mb-0">{{ stats.pending_invitations }}</h4>
                    <p class="text-muted mb-0">دعوتنامه‌ها</p>
                </div>
                <div class="bg-warning rounded-circle p-3">
                    <i class="bi bi-envelope text-white fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="role-badge role-{{ user_role.role|lower }} fs-6">
                        {{ user_role.get_role_display }}
                    </span>
                    <p class="text-muted mb-0 mt-1">نقش شما</p>
                </div>
                <div class="bg-info rounded-circle p-3">
                    <i class="bi bi-person-badge text-white fs-4"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- اطلاعات اصلی شرکت -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light py-3">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    اطلاعات شرکت
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <!-- لوگو و اطلاعات کلی -->
                    <div class="col-md-4 text-center">
                        {% if company.logo %}
                        <img src="{{ company.logo.url }}" alt="{{ company.name }}" 
                             class="img-fluid rounded shadow-sm mb-3" style="max-height: 150px;">
                        {% else %}
                        <div class="bg-secondary rounded d-flex align-items-center justify-content-center mb-3" 
                             style="height: 150px;">
                            <i class="bi bi-building text-white fs-1"></i>
                        </div>
                        {% endif %}
                        
                        <h5 class="fw-bold text-dark">{{ company.name }}</h5>
                        <p class="text-muted">{{ company.get_company_type_display }}</p>
                        
                        <div class="d-grid gap-2">
                            {% if request.session.current_company_id != company.id %}
                            <a href="{% url 'users:set_current_company' company.id %}" 
                               class="btn btn-primary btn-sm">
                                <i class="bi bi-check-circle me-1"></i>
                                انتخاب این شرکت
                            </a>
                            {% else %}
                            <span class="btn btn-success btn-sm disabled">
                                <i class="bi bi-check-circle me-1"></i>
                                شرکت فعال
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- اطلاعات جزئی -->
                    <div class="col-md-8">
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <strong class="text-primary">کد اقتصادی:</strong>
                                <p class="text-muted mb-2">{{ company.economic_code }}</p>
                            </div>
                            
                            <div class="col-sm-6">
                                <strong class="text-primary">شناسه ملی:</strong>
                                <p class="text-muted mb-2">{{ company.national_code }}</p>
                            </div>
                            
                            <div class="col-12">
                                <strong class="text-primary">آدرس:</strong>
                                <p class="text-muted mb-2">{{ company.address|default:"ثبت نشده" }}</p>
                            </div>
                            
                            <div class="col-sm-6">
                                <strong class="text-primary">تلفن:</strong>
                                <p class="text-muted mb-2">{{ company.phone|default:"ثبت نشده" }}</p>
                            </div>
                            
                            <div class="col-sm-6">
                                <strong class="text-primary">ایمیل:</strong>
                                <p class="text-muted mb-2">{{ company.email|default:"ثبت نشده" }}</p>
                            </div>
                            
                            {% if company.website %}
                            <div class="col-sm-6">
                                <strong class="text-primary">وبسایت:</strong>
                                <p class="text-muted mb-2">
                                    <a href="{{ company.website }}" target="_blank" class="text-decoration-none">
                                        {{ company.website }}
                                    </a>
                                </p>
                            </div>
                            {% endif %}
                            
                            <div class="col-sm-6">
                                <strong class="text-primary">سال مالی جاری:</strong>
                                <p class="text-muted mb-2">{{ company.current_fiscal_year }}</p>
                            </div>
                            
                            <div class="col-sm-6">
                                <strong class="text-primary">واحد پول:</strong>
                                <p class="text-muted mb-2">{{ company.get_currency_display }}</p>
                            </div>
                            
                            <div class="col-sm-6">
                                <strong class="text-primary">وضعیت:</strong>
                                <p class="text-muted mb-2">
                                    {% if company.is_active %}
                                    <span class="badge bg-success">فعال</span>
                                    {% else %}
                                    <span class="badge bg-secondary">غیرفعال</span>
                                    {% endif %}
                                    
                                    {% if company.is_verified %}
                                    <span class="badge bg-info me-1">تأیید شده</span>
                                    {% endif %}
                                </p>
                            </div>
                            
                            {% if company.description %}
                            <div class="col-12">
                                <strong class="text-primary">توضیحات:</strong>
                                <p class="text-muted">{{ company.description }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- اطلاعات مالی -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-light py-3">
                <h5 class="mb-0">
                    <i class="bi bi-calendar me-2"></i>
                    اطلاعات مالی
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <strong class="text-primary">شروع سال مالی:</strong>
                        <p class="text-muted mb-2">{{ company.fiscal_year_start|date:"Y/m/d" }}</p>
                    </div>
                    
                    <div class="col-md-6">
                        <strong class="text-primary">پایان سال مالی:</strong>
                        <p class="text-muted mb-2">{{ company.fiscal_year_end|date:"Y/m/d" }}</p>
                    </div>
                    
                    <div class="col-md-6">
                        <strong class="text-primary">ایجاد شده توسط:</strong>
                        <p class="text-muted mb-2">
                            {{ company.created_by.get_full_name|default:company.created_by.username }}
                        </p>
                    </div>
                    
                    <div class="col-md-6">
                        <strong class="text-primary">تاریخ ایجاد:</strong>
                        <p class="text-muted mb-2">{{ company.created_at|date:"Y/m/d - H:i" }}</p>
                    </div>
                    
                    <div class="col-md-6">
                        <strong class="text-primary">آخرین بروزرسانی:</strong>
                        <p class="text-muted mb-2">{{ company.updated_at|date:"Y/m/d - H:i" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- سایدبار - اطلاعات دسترسی -->
    <div class="col-lg-4">
        <!-- دسترسی‌های شما -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-info text-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-shield-check me-2"></i>
                    دسترسی‌های شما
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="fw-semibold">نقش:</span>
                    <span class="role-badge role-{{ user_role.role|lower }}">
                        {{ user_role.get_role_display }}
                    </span>
                </div>
                
                <div class="access-list">
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span>مدیریت کاربران</span>
                        <i class="bi {% if user_role.can_manage_users %}bi-check-circle text-success{% else %}bi-x-circle text-danger{% endif %}"></i>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span>مدیریت داده مالی</span>
                        <i class="bi {% if user_role.can_manage_financial_data %}bi-check-circle text-success{% else %}bi-x-circle text-danger{% endif %}"></i>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span>مشاهده گزارش‌ها</span>
                        <i class="bi {% if user_role.can_view_reports %}bi-check-circle text-success{% else %}bi-x-circle text-danger{% endif %}"></i>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span>خروجی گرفتن</span>
                        <i class="bi {% if user_role.can_export_data %}bi-check-circle text-success{% else %}bi-x-circle text-danger{% endif %}"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- اقدامات سریع -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-lightning me-2"></i>
                    اقدامات سریع
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if request.session.current_company_id != company.id %}
                    <a href="{% url 'users:set_current_company' company.id %}" 
                       class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>
                        انتخاب این شرکت
                    </a>
                    {% else %}
                    <a href="{% url 'users:dashboard' %}" 
                       class="btn btn-success">
                        <i class="bi bi-speedometer2 me-1"></i>
                        رفتن به داشبورد
                    </a>
                    {% endif %}
                    
                    {% if user_role.role in 'OWNER,ADMIN' %}
                    <a href="{% url 'users:update_company' company.id %}" 
                       class="btn btn-outline-warning">
                        <i class="bi bi-pencil me-1"></i>
                        ویرایش اطلاعات
                    </a>
                    
                    <a href="{% url 'users:manage_company_members' company.id %}" 
                       class="btn btn-outline-info">
                        <i class="bi bi-people me-1"></i>
                        مدیریت اعضا
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'users:company_list' %}" 
                       class="btn btn-outline-secondary">
                        <i class="bi bi-list-ul me-1"></i>
                        همه شرکت‌ها
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}