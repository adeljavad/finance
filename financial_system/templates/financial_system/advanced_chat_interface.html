<!-- financial_system/templates/financial_system/advanced_chat_interface.html -->
{% extends 'financial_system/base.html' %}

{% block title %}Ú†Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù…Ø§Ù„ÛŒ - Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-robot text-primary"></i>
        Ú†Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù…Ø§Ù„ÛŒ
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <span class="btn btn-outline-success">
                <i class="bi bi-stars"></i>
                Ù†Ø³Ø®Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Û².Û°
            </span>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Ú†Øª Ø¨Ø§Ú©Ø³ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cpu text-primary"></i>
                    Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø§Ù„ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡
                </h5>
                <small class="text-muted">Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ´Ø±ÙØªÙ‡ ØªØ­Ù„ÛŒÙ„ Ùˆ Ù…Ø´Ø§ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ú¯Ø³ØªØ±Ø¯Ù‡</small>
            </div>
            <div class="card-body">
                <div id="chat-container" style="height: 450px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #f8f9fa;">
                    <div id="chat-messages">
                        <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ -->
                        <div class="alert alert-primary text-center">
                            <i class="bi bi-info-circle"></i>
                            Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ú†Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù…Ø§Ù„ÛŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³ÙˆØ§Ù„Ø§Øª Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ù…Ø§Ù„ÛŒØŒ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ØŒ Ùˆ Ù…Ø´Ø§ÙˆØ±Ù‡ ØªØ®ØµØµÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯.
                        </div>
                        <div class="alert alert-info">
                            <h6><i class="bi bi-lightning-charge"></i> Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…:</h6>
                            <ul class="mb-0 small">
                                <li>ØªØ­Ù„ÛŒÙ„ Ù†Ø³Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</li>
                                <li>Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø§Ù†Ø­Ø±Ø§ÙØ§Øª Ùˆ Ø±ÛŒØ³Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ</li>
                                <li>Ù…Ø´Ø§ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒØ§ØªÛŒ Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…Ø§Ù„ÛŒ</li>
                                <li>ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <!-- Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
                    <div class="btn-group btn-group-sm mb-2 w-100" role="group" aria-label="Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´">
                        <button type="button" class="btn btn-outline-primary" onclick="formatText('bold')" title="Ù¾Ø±Ø±Ù†Ú¯">
                            <i class="bi bi-type-bold"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="formatText('italic')" title="Ú©Ø¬">
                            <i class="bi bi-type-italic"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="formatText('underline')" title="Ø²ÛŒØ±Ø®Ø·">
                            <i class="bi bi-type-underline"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="insertExample('analysis')" title="Ø¯Ø±Ø¬ Ù…Ø«Ø§Ù„ ØªØ­Ù„ÛŒÙ„">
                            <i class="bi bi-graph-up"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="insertExample('tax')" title="Ø¯Ø±Ø¬ Ù…Ø«Ø§Ù„ Ù…Ø§Ù„ÛŒØ§ØªÛŒ">
                            <i class="bi bi-calculator"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="clearText()" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†">
                            <i class="bi bi-eraser"></i>
                        </button>
                    </div>
                    
                    <textarea id="chat-input" class="form-control" placeholder="Ø³ÙˆØ§Ù„ Ù…Ø§Ù„ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³ÛŒØ¯ (Ù…Ø«Ø§Ù„: ØªØ­Ù„ÛŒÙ„ Ø±ÛŒØ³Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ Ø´Ø±Ú©ØªØŒ Ù…Ø´Ø§ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø­ Ø¬Ø¯ÛŒØ¯ØŒ ...)" 
                              rows="4" style="resize: vertical; min-height: 100px;"></textarea>
                    <button class="btn btn-primary" id="send-btn">
                        <i class="bi bi-send"></i>
                        Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ´Ø±ÙØªÙ‡
                    </button>
                </div>
                
                <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label small">Ø´Ù†Ø§Ø³Ù‡ Ø´Ø±Ú©Øª:</label>
                            <input type="number" id="company-id" class="form-control form-control-sm" value="1" min="1">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label small">Ø¯ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒ:</label>
                            <input type="number" id="period-id" class="form-control form-control-sm" value="1" min="1">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label small">Ø³Ø¨Ú© Ù¾Ø§Ø³Ø®:</label>
                            <select id="response-style" class="form-select form-select-sm">
                                <option value="detailed">Ù…ÙØµÙ„ Ùˆ ØªØ­Ù„ÛŒÙ„ÛŒ</option>
                                <option value="concise">Ù…Ø®ØªØµØ± Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ</option>
                                <option value="technical">ÙÙ†ÛŒ Ùˆ ØªØ®ØµØµÛŒ</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="card-title mb-0">
                    <i class="bi bi-stars text-warning"></i>
                    Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡
                </h6>
            </div>
            <div class="card-body">
                <h6>Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡:</h6>
                <ul class="small">
                    <li><strong>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ùˆ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§:</strong> Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒØŒ Ø§ØµÙˆÙ„ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡</li>
                    <li><strong>Ù…Ø§Ù„ÛŒØ§Øª Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…Ø§Ù„ÛŒ:</strong> Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…Ø§Ù„ÛŒØ§ØªÛŒØŒ Ù…Ø¹Ø§ÙÛŒØªâ€ŒÙ‡Ø§ØŒ Ø§Ø¸Ù‡Ø§Ø±Ù†Ø§Ù…Ù‡</li>
                    <li><strong>ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ:</strong> Ù†Ø³Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ØŒ ØªØ­Ù„ÛŒÙ„ Ø±ÙˆÙ†Ø¯ØŒ Ø¨Ù†Ú†Ù…Ø§Ø±Ú©ÛŒÙ†Ú¯</li>
                    <li><strong>Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ Ùˆ Ú©Ù†ØªØ±Ù„:</strong> Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒØŒ Ø±ÛŒØ³Ú© Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ</li>
                    <li><strong>Ù…Ø´Ø§ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒ:</strong> Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù…Ø§Ù„ÛŒØŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒØŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©</li>
                </ul>
                
                <hr>
                
                <h6 class="text-success">Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡:</h6>
                <div class="row mt-2">
                    <div class="col-12 mb-2">
                        <button class="btn btn-outline-success w-100 sample-question" data-question="ØªØ­Ù„ÛŒÙ„ Ø±ÛŒØ³Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ Ø§ØµÙ„ÛŒ Ø´Ø±Ú©Øª Ø±Ø§ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯">
                            <i class="bi bi-shield-exclamation"></i>
                            ØªØ­Ù„ÛŒÙ„ Ø±ÛŒØ³Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ
                        </button>
                    </div>
                    <div class="col-12 mb-2">
                        <button class="btn btn-outline-success w-100 sample-question" data-question="Ù…Ø´Ø§ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ø¬Ø¯ÛŒØ¯">
                            <i class="bi bi-calculator"></i>
                            Ù…Ø´Ø§ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒØ§ØªÛŒ
                        </button>
                    </div>
                    <div class="col-12 mb-2">
                        <button class="btn btn-outline-success w-100 sample-question" data-question="ØªØ­Ù„ÛŒÙ„ Ù†Ø³Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù‡Ø±Ù…ÛŒ Ùˆ Ø³Ø§Ø®ØªØ§Ø± Ø³Ø±Ù…Ø§ÛŒÙ‡">
                            <i class="bi bi-graph-up-arrow"></i>
                            ØªØ­Ù„ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø± Ø³Ø±Ù…Ø§ÛŒÙ‡
                        </button>
                    </div>
                    <div class="col-12 mb-2">
                        <button class="btn btn-outline-success w-100 sample-question" data-question="Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø§Ù†Ø­Ø±Ø§ÙØ§Øª Ù…Ø§Ù„ÛŒ Ùˆ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ">
                            <i class="bi bi-clipboard-check"></i>
                            Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ
                        </button>
                    </div>
                </div>
                
                <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ… -->
                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…:</h6>
                    <ul class="small mb-0">
                        <li><strong>Ù†Ø§Ù…:</strong> Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø§Ù„ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</li>
                        <li><strong>Ù†Ø³Ø®Ù‡:</strong> Û².Û°.Û°</li>
                        <li><strong>Ù¾Ø±Ø¯Ø§Ø²Ø´:</strong> Ø²Ù…Ø§Ù† ÙˆØ§Ù‚Ø¹ÛŒ</li>
                        <li><strong>Ø§Ù…Ù†ÛŒØª:</strong> Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„</li>
                    </ul>
                </div>
                
                <!-- Ø¯Ú©Ù…Ù‡ ØªØ³Øª Ø³ÛŒØ³ØªÙ… -->
                <button class="btn btn-outline-primary w-100 mt-2" id="test-system-btn">
                    <i class="bi bi-play-circle"></i>
                    ØªØ³Øª Ø³Ù„Ø§Ù…Øª Ø³ÛŒØ³ØªÙ…
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatContainer = document.getElementById('chat-container');
    const sampleQuestions = document.querySelectorAll('.sample-question');
    const testSystemBtn = document.getElementById('test-system-btn');
    const companyIdInput = document.getElementById('company-id');
    const periodIdInput = document.getElementById('period-id');
    const responseStyleSelect = document.getElementById('response-style');
    
    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ú†Øª
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú†Øª
    function addMessage(message, isUser = false, messageType = 'normal') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 ${isUser ? 'text-start' : 'text-end'}`;
        
        const bubble = document.createElement('div');
        bubble.className = `d-inline-block p-3 rounded-3 position-relative ${isUser ? 'bg-primary text-white' : getMessageBubbleClass(messageType)}`;
        bubble.style.maxWidth = '80%';
        
        // Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù…
        let icon = '';
        if (!isUser) {
            switch(messageType) {
                case 'analysis':
                    icon = '<i class="bi bi-graph-up me-2"></i>';
                    break;
                case 'warning':
                    icon = '<i class="bi bi-exclamation-triangle me-2"></i>';
                    break;
                case 'success':
                    icon = '<i class="bi bi-check-circle me-2"></i>';
                    break;
                case 'info':
                    icon = '<i class="bi bi-info-circle me-2"></i>';
                    break;
                default:
                    icon = '<i class="bi bi-robot me-2"></i>';
            }
        }
        
        // Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ§Ù…
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        if (typeof message === 'string') {
            messageContent.innerHTML = icon + message.replace(/\n/g, '<br>');
        } else {
            messageContent.appendChild(message);
        }
        bubble.appendChild(messageContent);
        
        // Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„
        const timeSpan = document.createElement('div');
        timeSpan.className = 'small text-muted mt-1 text-start';
        timeSpan.style.fontSize = '0.75rem';
        const now = new Date();
        timeSpan.textContent = now.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        bubble.appendChild(timeSpan);
        
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // Ú©Ù„Ø§Ø³ bubble Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù…
    function getMessageBubbleClass(messageType) {
        switch(messageType) {
            case 'analysis':
                return 'bg-light border border-info';
            case 'warning':
                return 'bg-warning-subtle border border-warning';
            case 'success':
                return 'bg-success-subtle border border-success';
            case 'info':
                return 'bg-info-subtle border border-info';
            default:
                return 'bg-light border';
        }
    }
    
    // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
    function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) {
            addMessage('âŒ Ø®Ø·Ø§: Ù¾ÛŒØ§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯', false, 'warning');
            return;
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±
        addMessage(message, true);
        chatInput.value = '';
        
        // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´
        const typingDiv = document.createElement('div');
        typingDiv.className = 'text-center text-muted mb-3';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = '<i class="bi bi-robot"></i> Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø³ÙˆØ§Ù„...';
        chatMessages.appendChild(typingDiv);
        scrollToBottom();
        
        // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± (API Ù¾ÛŒØ´Ø±ÙØªÙ‡)
        fetch("{% url 'financial_system:advanced_chat_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                question: message,
                company_id: parseInt(companyIdInput.value) || 1,
                period_id: parseInt(periodIdInput.value) || 1,
                response_style: responseStyleSelect.value
            })
        })
        .then(response => response.json())
        .then(data => {
            // Ø­Ø°Ù Ù†Ø´Ø§Ù†Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´
            document.getElementById('typing-indicator')?.remove();
            
            if (!data.success) {
                addMessage(`âŒ Ø®Ø·Ø§: ${data.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}`, false, 'warning');
            } else {
                // Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®
                displayAdvancedResponse(data);
            }
        })
        .catch(error => {
            document.getElementById('typing-indicator')?.remove();
            addMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡', false, 'warning');
            console.error('Error:', error);
        });
    }
    
    // Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø® Ù¾ÛŒØ´Ø±ÙØªÙ‡
    function displayAdvancedResponse(data) {
        let messageType = 'info';
        let messageContent = '';
        
        if (data.system_info) {
            // Ù¾Ø§Ø³Ø® Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…
            messageType = 'info';
            messageContent = formatSystemInfo(data);
        } else if (data.answer || data.response) {
            // Ù¾Ø§Ø³Ø® Ù…ØªÙ†ÛŒ
            messageType = 'analysis';
            const answer = data.answer || data.response;
            messageContent = formatTextResponse(answer, data);
        } else if (data.analysis) {
            // Ù¾Ø§Ø³Ø® ØªØ­Ù„ÛŒÙ„ÛŒ
            messageType = 'analysis';
            messageContent = formatAnalysisResponse(data);
        } else {
            // Ù¾Ø§Ø³Ø® Ø¹Ù…ÙˆÙ…ÛŒ
            messageType = 'info';
            messageContent = formatGenericResponse(data);
        }
        
        addMessage(messageContent, false, messageType);
    }
    
    // ÙØ±Ù…Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…
    function formatSystemInfo(data) {
        const info = data.system_info;
        let html = `
            <div class="text-center mb-2">
                <h6 class="text-primary">${info.name}</h6>
                <small class="text-muted">Ù†Ø³Ø®Ù‡ ${info.version}</small>
            </div>
            <div class="mb-3">
                <h6>Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…:</h6>
                <ul class="small mb-2">
                    ${info.capabilities.map(cap => `<li>${cap}</li>`).join('')}
                </ul>
            </div>
            <div>
                <h6>Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:</h6>
                <ul class="small mb-0">
                    ${info.supported_domains.map(domain => `<li>${domain}</li>`).join('')}
                </ul>
            </div>
        `;
        return html;
    }
    
    // ÙØ±Ù…Øª Ù¾Ø§Ø³Ø® Ù…ØªÙ†ÛŒ
    function formatTextResponse(answer, data) {
        let html = `
            <div class="mb-2">
                <h6><i class="bi bi-chat-square-text"></i> Ù¾Ø§Ø³Ø® Ø³ÛŒØ³ØªÙ…:</h6>
                <div class="p-2 bg-white rounded border">
                    ${answer.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
        
        // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ø§Ø¶Ø§ÙÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
        if (data.metadata || data.sources) {
            html += `<hr class="my-2">`;
            
            if (data.metadata) {
                html += `
                    <div class="small text-muted">
                        <i class="bi bi-tags"></i>
                        <strong>Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§:</strong> ${Array.isArray(data.metadata.tags) ? data.metadata.tags.join(', ') : data.metadata.tags || 'Ø¹Ù…ÙˆÙ…ÛŒ'}
                    </div>
                `;
            }
            
            if (data.sources && data.sources.length > 0) {
                html += `
                    <div class="small text-muted mt-1">
                        <i class="bi bi-link"></i>
                        <strong>Ù…Ù†Ø§Ø¨Ø¹:</strong>
                        <ul class="mb-0">
                            ${data.sources.map(source => `<li>${source}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        }
        
        return html;
    }
    
    // ÙØ±Ù…Øª Ù¾Ø§Ø³Ø® ØªØ­Ù„ÛŒÙ„ÛŒ
    function formatAnalysisResponse(data) {
        const analysis = data.analysis;
        let html = `
            <div class="mb-2">
                <h6><i class="bi bi-graph-up"></i> ØªØ­Ù„ÛŒÙ„ Ø³ÛŒØ³ØªÙ…:</h6>
                <div class="p-2 bg-white rounded border">
                    ${analysis.summary.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
        
        if (analysis.recommendations && analysis.recommendations.length > 0) {
            html += `
                <div class="mt-2">
                    <h6><i class="bi bi-lightbulb"></i> ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§:</h6>
                    <ul class="small">
                        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        return html;
    }
    
    // ÙØ±Ù…Øª Ù¾Ø§Ø³Ø® Ø¹Ù…ÙˆÙ…ÛŒ
    function formatGenericResponse(data) {
        return `
            <div class="mb-2">
                <h6><i class="bi bi-file-earmark-text"></i> Ù¾Ø§Ø³Ø® Ø³ÛŒØ³ØªÙ…:</h6>
                <div class="p-2 bg-white rounded border">
                    ${JSON.stringify(data, null, 2).replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
    }
    
    // ØªÙˆØ§Ø¨Ø¹ ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ Ù…ØªÙ†
    function formatText(command) {
        const textarea = document.getElementById('chat-input');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        let formattedText = '';
        switch(command) {
            case 'bold':
                formattedText = `**${selectedText}**`;
                break;
            case 'italic':
                formattedText = `*${selectedText}*`;
                break;
            case 'underline':
                formattedText = `__${selectedText}__`;
                break;
            default:
                formattedText = selectedText;
        }
        
        textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
        textarea.focus();
        textarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
    }
    
    function insertExample(type) {
        const examples = {
            analysis: "ØªØ­Ù„ÛŒÙ„ Ø±ÛŒØ³Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ Ø§ØµÙ„ÛŒ Ø´Ø±Ú©Øª Ø±Ø§ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯",
            tax: "Ù…Ø´Ø§ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ø¬Ø¯ÛŒØ¯"
        };
        
        const textarea = document.getElementById('chat-input');
        textarea.value = examples[type] || "Ø³ÙˆØ§Ù„ Ù…Ø§Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...";
        textarea.focus();
    }
    
    function clearText() {
        document.getElementById('chat-input').value = '';
        document.getElementById('chat-input').focus();
    }
    
    // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Ø³ÙˆØ§Ù„Ø§Øª Ù†Ù…ÙˆÙ†Ù‡
    sampleQuestions.forEach(btn => {
        btn.addEventListener('click', function() {
            const question = this.getAttribute('data-question');
            document.getElementById('chat-input').value = question;
            document.getElementById('chat-input').focus();
        });
    });
    
    // ØªØ³Øª Ø³ÛŒØ³ØªÙ…
    testSystemBtn.addEventListener('click', function() {
        addMessage('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø³Ù„Ø§Ù…Øª Ø³ÛŒØ³ØªÙ…...', false, 'info');
        
        fetch("{% url 'financial_system:advanced_chat_api' %}", {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.system_info) {
                addMessage('âœ… Ø³ÛŒØ³ØªÙ… Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø³Ø§Ù„Ù… Ø§Ø³Øª!', false, 'success');
                addMessage(formatSystemInfo(data), false, 'info');
            } else {
                addMessage('âš ï¸ Ø³ÛŒØ³ØªÙ… Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯ Ø§Ù…Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…Ø´Ú©Ù„Ø§ØªÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯', false, 'warning');
            }
        })
        .catch(error => {
            addMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³ÛŒØ³ØªÙ…', false, 'warning');
        });
    });
    
    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
    scrollToBottom();
});
</script>
{% endblock %}
